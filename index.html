<!doctype html>

<head>
  <meta charset="utf-8">
  <title>WebStunts</title>

<script id="stunts-vs" type="x-shader/x-vertex">
// -*- c -*-

uniform mat4 worldProjection;
uniform mat3 normalProjection;

attribute vec3 vertexPosition;
attribute vec3 vertexNormal;
attribute vec3 vertexColour;
attribute vec3 vertexMaterialInfo;

varying vec3 fragmentPosition;
varying vec3 fragmentNormal;
varying vec3 fragmentColour;
varying vec3 fragmentMaterialInfo;
varying vec3 eyePosition;

void main(void) {
  vec4 p = vec4(vertexPosition, 1.0);
  vec4 e = worldProjection * p;
  fragmentPosition = vertexPosition;
  fragmentNormal = normalize(normalProjection * vertexNormal);
  fragmentColour = vertexColour;
  fragmentMaterialInfo = vertexMaterialInfo;
  eyePosition = e.xyz;
  gl_Position = e;
  gl_Position.z = -(e.z + (e.z + 0.5) * vertexMaterialInfo.r);
}
</script>

<script id="stunts-fs" type="x-shader/x-fragment">
// -*- c -*-

#ifdef GL_ES
precision highp float;
#ifdef ANTI_MOIRE_ENABLED
#extension GL_OES_standard_derivatives : enable
#endif
#endif

uniform vec3 lightPosition;

varying vec3 fragmentPosition;
varying vec3 fragmentNormal;
varying vec3 fragmentColour;
varying vec3 fragmentMaterialInfo;
varying vec3 eyePosition;

#ifdef ANTI_MOIRE_ENABLED
float perturb(float x, float r) {
  float w = fwidth(x);

  return x + r * w * w * 2.0;
}
#endif

bool is_solid() {
#ifdef ANTI_MOIRE_ENABLED
  //float rand = texture2D(noiseSampler, gl_FragCoord.xy);
  float rand1 = fract(sin(dot(gl_FragCoord.xy, vec2(12.9898, 78.233))) * 43758.5453) - 0.5;
  float rand2 = fract(sin(dot(gl_FragCoord.zx, vec2(15.9898, 74.233))) * 53758.5453) - 0.5;
  float rand3 = fract(sin(dot(gl_FragCoord.yz, vec2(18.9898, 71.233))) * 73758.5453) - 0.5;

  float prod1 = dot(fragmentPosition, vec3(2.0, 2.0, -2.0));
  float prod2 = dot(fragmentPosition, vec3(2.0, -2.0, 2.0));
  float prod3 = dot(fragmentPosition, vec3(-2.0, 2.0, 2.0));

  return
    fract(perturb(prod1, rand1)) < 0.2 ||
    fract(perturb(prod2, rand2)) < 0.2 ||
    fract(perturb(prod3, rand3)) < 0.2;
#else
  return
    fract(dot(fragmentPosition, vec3(2.0, 2.0, -2.0))) < 0.2 ||
    fract(dot(fragmentPosition, vec3(2.0, -2.0, 2.0))) < 0.2 ||
    fract(dot(fragmentPosition, vec3(-2.0, 2.0, 2.0))) < 0.2;
#endif
}

void main(void) {
  float surf = fragmentMaterialInfo.b;

  if (surf > 0.25 && (surf > 0.75 || is_solid())) {
    vec3 l = normalize(lightPosition - eyePosition);
    vec3 e = normalize(-eyePosition);
    vec3 n = fragmentNormal;
    vec3 r = normalize(reflect(-l, n));

    float lambert = max(dot(l, n), 0.0);
    float phong = max(dot(r, e), 0.0);
    float shininess = fragmentMaterialInfo.g;
    float intensity = 0.2 + lambert * 0.5 + pow(phong, shininess) * 0.3;
    float highlight = pow(phong, shininess) * min(1.0, shininess * 0.04);

    vec3 rgb = intensity * fragmentColour + highlight * vec3(1.0, 1.0, 1.0);
    //rgb = vec3(gl_FragCoord.z * 50.0);
    gl_FragColor = vec4(rgb, 1.0);
  } else {
    discard;
  }
}
</script>

<script type="text/javascript" src="glMatrix.js"></script>
<script type="text/javascript" src="models.js"></script>
<script type="text/javascript" src="stunts.js"></script>

<script type="text/javascript" src="./jiglibjs2/jiglib.js"></script>

<script type="text/javascript" src="./jiglibjs2/geom/Vector3D.js"></script>
<script type="text/javascript" src="./jiglibjs2/geom/Matrix3D.js"></script>

<script type="text/javascript" src="./jiglibjs2/math/JMatrix3D.js"></script>
<script type="text/javascript" src="./jiglibjs2/math/JMath3D.js"></script>
<script type="text/javascript" src="./jiglibjs2/math/JNumber3D.js"></script>

<script type="text/javascript" src="./jiglibjs2/cof/JConfig.js"></script>
<script type="text/javascript" src="./jiglibjs2/data/CollOutData.js"></script>
<script type="text/javascript" src="./jiglibjs2/data/ContactData.js"></script>
<script type="text/javascript" src="./jiglibjs2/data/PlaneData.js"></script>
<script type="text/javascript" src="./jiglibjs2/data/EdgeData.js"></script>
<script type="text/javascript" src="./jiglibjs2/data/TerrainData.js"></script>
<script type="text/javascript" src="./jiglibjs2/geometry/JAABox.js"></script>
<script type="text/javascript" src="./jiglibjs2/data/OctreeCell.js"></script>
<script type="text/javascript" src="./jiglibjs2/data/CollOutBodyData.js"></script>
<script type="text/javascript" src="./jiglibjs2/data/TriangleVertexIndices.js"></script>
<script type="text/javascript" src="./jiglibjs2/data/SpanData.js"></script>
<script type="text/javascript" src="./jiglibjs2/physics/constraint/JConstraint.js"></script>
<script type="text/javascript" src="./jiglibjs2/physics/constraint/JConstraintMaxDistance.js"></script>
<script type="text/javascript" src="./jiglibjs2/physics/constraint/JConstraintWorldPoint.js"></script>
<script type="text/javascript" src="./jiglibjs2/physics/constraint/JConstraintPoint.js"></script>
<script type="text/javascript" src="./jiglibjs2/physics/MaterialProperties.js"></script>
<script type="text/javascript" src="./jiglibjs2/geometry/JTriangle.js"></script>
<script type="text/javascript" src="./jiglibjs2/geometry/JSegment.js"></script>
<script type="text/javascript" src="./jiglibjs2/collision/CollPointInfo.js"></script>
<script type="text/javascript" src="./jiglibjs2/collision/CollisionInfo.js"></script>
<script type="text/javascript" src="./jiglibjs2/collision/CollDetectInfo.js"></script>
<script type="text/javascript" src="./jiglibjs2/collision/CollDetectFunctor.js"></script>
<script type="text/javascript" src="./jiglibjs2/collision/CollDetectBoxTerrain.js"></script>
<script type="text/javascript" src="./jiglibjs2/collision/CollDetectSphereMesh.js"></script>
<script type="text/javascript" src="./jiglibjs2/collision/CollDetectCapsuleBox.js"></script>
<script type="text/javascript" src="./jiglibjs2/collision/CollDetectSphereCapsule.js"></script>
<script type="text/javascript" src="./jiglibjs2/collision/CollDetectCapsuleTerrain.js"></script>
<script type="text/javascript" src="./jiglibjs2/collision/CollDetectSphereBox.js"></script>
<script type="text/javascript" src="./jiglibjs2/collision/CollDetectSphereTerrain.js"></script>
<script type="text/javascript" src="./jiglibjs2/collision/CollDetectBoxBox.js"></script>
<script type="text/javascript" src="./jiglibjs2/collision/CollDetectBoxMesh.js"></script>
<script type="text/javascript" src="./jiglibjs2/collision/CollDetectBoxPlane.js"></script>
<script type="text/javascript" src="./jiglibjs2/collision/CollDetectCapsuleCapsule.js"></script>
<script type="text/javascript" src="./jiglibjs2/collision/CollDetectSphereSphere.js"></script>
<script type="text/javascript" src="./jiglibjs2/collision/CollDetectSpherePlane.js"></script>
<script type="text/javascript" src="./jiglibjs2/collision/CollDetectCapsulePlane.js"></script>
<script type="text/javascript" src="./jiglibjs2/collision/CollisionSystemAbstract.js"></script>
<script type="text/javascript" src="./jiglibjs2/collision/CollisionSystemGridEntry.js"></script>
<script type="text/javascript" src="./jiglibjs2/collision/CollisionSystemGrid.js"></script>
<script type="text/javascript" src="./jiglibjs2/collision/CollisionSystemBrute.js"></script>
<script type="text/javascript" src="./jiglibjs2/geometry/JIndexedTriangle.js"></script>
<script type="text/javascript" src="./jiglibjs2/geometry/JOctree.js"></script>
<script type="text/javascript" src="./jiglibjs2/geometry/JRay.js"></script>
<script type="text/javascript" src="./jiglibjs2/events/JCollisionEvent.js"></script>
<script type="text/javascript" src="./jiglibjs2/physics/constraint/JConstraint.js"></script>
<script type="text/javascript" src="./jiglibjs2/physics/constraint/JConstraintMaxDistance.js"></script>
<script type="text/javascript" src="./jiglibjs2/physics/constraint/JConstraintWorldPoint.js"></script>
<script type="text/javascript" src="./jiglibjs2/physics/constraint/JConstraintPoint.js"></script>
<script type="text/javascript" src="./jiglibjs2/physics/PhysicsController.js"></script>
<script type="text/javascript" src="./jiglibjs2/physics/CachedImpulse.js"></script>
<script type="text/javascript" src="./jiglibjs2/physics/HingeJoint.js"></script>
<script type="text/javascript" src="./jiglibjs2/physics/BodyPair.js"></script>
<script type="text/javascript" src="./jiglibjs2/physics/PhysicsState.js"></script>
<script type="text/javascript" src="./jiglibjs2/physics/PhysicsSystem.js"></script>
<script type="text/javascript" src="./jiglibjs2/physics/RigidBody.js"></script>
<script type="text/javascript" src="./jiglibjs2/geometry/JSphere.js"></script>
<script type="text/javascript" src="./jiglibjs2/geometry/JTriangleMesh.js"></script>
<script type="text/javascript" src="./jiglibjs2/geometry/JPlane.js"></script>
<script type="text/javascript" src="./jiglibjs2/geometry/JTerrain.js"></script>
<script type="text/javascript" src="./jiglibjs2/geometry/JBox.js"></script>
<script type="text/javascript" src="./jiglibjs2/geometry/JCapsule.js"></script>
<script type="text/javascript" src="./jiglibjs2/debug/Stats.js"></script>

<script type="text/javascript" src="./jiglibjs2/vehicles/JChassis.js"></script>
<script type="text/javascript" src="./jiglibjs2/vehicles/JWheel.js"></script>
<script type="text/javascript" src="./jiglibjs2/vehicles/JCar.js"></script>

</head>

<body onload="start();">

  <div>
    <p>Load Stunts track file: <input type="file" id="track-file"> (needs <code>--allow-file-access-from-files</code> flag for Chrome)</p>

    <p>Controls: arrows move the car, space is the hand brake, C cycles through the car models, R resets the current car</p>

    <p><a href="https://github.com/cobbpg/webstunts">Source repository</a> (check the readme for some background info)</p>

    <canvas id="stunts-canvas" style="border: none" width="960" height="600"></canvas>

    <div id="notifications"></div>
  </div>

</body>

</html>
